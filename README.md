# MOTOR
v 0.1.3

## Introduction

MOTOR is short for Meteorological Object-oriented Tools and Operators Repository - Data Assimilation. An OOP-based repository for meteorological applications specifically for Weather Forecasting Model and Data Assimilation. 

## Get the latest MOTOR and compilation
### Repository

MOTOR-DA use the repositories on coding.net:

```
git clone https://e.coding.net/opensimi/MOTOR/MOTOR.git
```
or through ssh:
```
git clone git@e.coding.net:opensimi/MOTOR/MOTOR.git
```
### Hierarchy of directories                     
```
root
├── build                       % Build directory   
├── ctemplates                   % Common used cmake file
├── etc                         % Docs and so on.
│   ├── docs                    % Doc files in Markdown
│   ├── image                   % Static images referred by docs
│   ├── doxygen                 % Doxygen compiler for API doc generation
│   ├── sphnix                  % Sphinx compiler for general docs
│   └── historicalCode
├── grid                        % Grid files
├── input                       % input files
├── output                      % output files
├── libs                        % Static libraries
├── mods                        % .mod files generated by .F90   
├── src                         % Source files
├── external                    % External third party libraries
└── static                      % Namelist files 
    └── test.nl                 % Config file for test applications
```
### Build the project

The required package for compliation are:

* **gfortran** (gnu 9.3.0 fully tested)/ **ifortran** (ifort 2019 fully tested)
* **gcc** / **icc**
* **openMPI** (4.0.2 fully tested) / **MPICH** / **MVAPICH**
* **CMake** >= 2.8
* **hdf5**
* **netcdf-c**
* **netcdf-fortran**

#### Prepare the environment

##### Build the environment locally
For linux based system, such as the ubuntu, centos, the compiler can be retrieved by the package manager. And get other libraries using the following steps:

1. Install the cmake with package manager;
2. Install the OpenMPI with package manager or compiling manaually;
3. Compile the hdf5 manaually;
4. Compile the netcdf-c manaually;
5. Compile the netcdf-fortran manaually;

##### Build the environment with SPACK

It is strongly recommended to use the `spack` to build the essential tool libs for certain compilers.
1. First, you have to install the spack through the github:
```shell
git clone -c feature.manyFiles=true https://github.com/spack/spack.git
```

2. Run the shell script to start the spack and add it to the `.bashrc` or `.zshrc`
```shell
# For bash/zsh/sh
. spack/share/spack/setup-env.sh
# For tcsh/csh
source spack/share/spack/setup-env.csh
# For fish
. spack/share/spack/setup-env.fish
```

3. Install the essential packages:
```shell
spack install openmpi%gcc
spack install hdf5%gcc+fortran+hl+mpi
spack install netcdf-fortran%gcc
```

4. Load them to the envs
```
spack load openmpi
spack load netcdf-fortran
```

5. For apple-clang+gfortran configurations, use the following commands to enable the OpenMP:
```
brew install llvm
brew install libomp
```

##### Use the docker image directely

Another simple way to prepare the development environment is to use the docker image-container we build already:
Install the docker application and run the scripts below:
```shell
# option 1 - development
# --name: name of this container.
# -ti: an interactive container with terminal open.
# -v: the mount of local directory: here, '/Users/qzl/source' is the local directory, '/sources' is the source directory in the container.
# zilongqin/motor-dev:latest is the image of the container at remote, it will be downloaded automatically.
# bash -i: ensure the .bashrc will be sourced initially.
docker run -ti -v /Users/qzl/source:/sources --name motor-dev-image zilongqin/motor-dev:latest bash -i
```

Here `/Users/qzl/source` in `-v /Users/qzl/source:/sources` is the local directory of your sources mounted to docker containers.

#### Use GitLab as an optional repository
1. Change the address of remote repository
``` 
    For the first time, you may need to add key to the GitLab
    cd `.git`
    edit  `url` in the `config` file:  `url = ssh://git@10.151.227.15:7022/idateam/MOTOR.git`
    Note that `10.151.227.15` is for local network only. Use `172.17.2.9` instead otherwise.
```
2. Sync GitLab and CODING：
```
    git remote add new_repo_name new_repo_address 
    git fetch new_repo_name
    git checkout -t new_repo_name/feature_branch_name
    git push origin(or new_repo_name) local_feature_branch
```
#### Compilation steps

First of all,

 `source pathEnv.sh`
Add the static variables to the system env.

Preparing steps
1. `git submodule update --init --remote --recursive`
Initialize the third-party sources like LAPACK and so on.

If the submodules cause the version error, try to use the following commands to reset the remote addresses:
`git pull --recurse-submodules`
(Remove the external/lapack external/fortran-yaml-cpp external/RTTOV and retry if it fails again.)

Compilation steps (under the root of MOTOR-DA):
1. `./compileExt.sh intel` or  `./compileExt.sh gnu-XX`
To compile the third-party libs before the compilation of MOTOR main programs.

1. `cd ./build`
Direct the current path to the build directory.

1. `cmake ..`
Configure the project, and generate the makefile with CMake tools.

1. `make`
Build the libs and programs with makefile.

1. `ctest`
Run the unit test to ensure the compilation is finished properly.

##### Note
For various platforms, we set different scripts to set up the paths, env and so on. Please check them before install and compilation.

1. submodule update: Before running `git pull --recurse-submodules` one should modify the config files under .git and .git/modules/external/ so that they direct the corrent git repositories to update these modules.
2. pathEnv: gnu and intel
3. setEnv: gnu and intel. setEnv.intel22.sh is set for our local HPC ShiYan for using intell 2022 version compiler.
4. on our local HPC ShiYan, run source  /public/software/profile.d/mathlib_hdf5-intel-1.8.12.sh to use the right HDF5 lib before running compileExt.intel.sh.

### Documentation system

MOTOR-DA uses **Doxygen** and **Sphinx** to maintain the docs of this project. All the technical docs have to be placed in the `$root/etc/docs`, all the doxygen api docs are generated from the source code comments in the specific format, and the general docs are written in markdown language. Before the compilation, the tools should be installed ahead:

* [Doxygen](https://www.doxygen.nl/index.html) 
(Tested version : V 1.10.0)

Binaries: 

[https://www.doxygen.nl/index.html](https://www.doxygen.nl/index.html)

apt-get:
```bash
apt-get install doxygen
apt-get install graphviz
```

Homebrew:
```bash
brew install doxygen
brew install graphviz
```

* [Sphinx](https://www.sphinx-doc.org/en/master/):
(Tested version : V 3.4.1)

PIP:

```bash
pip install -U Sphinx
```

And two extensions for supporting md files:

```bash
pip install --upgrade recommonmark
pip install --upgrade sphinx-markdown-tables
pip install --upgrade sphinx_rtd_theme
```


The configuration files for Doxygen and Sphinx are in the `$root/etc/docs` directory. They are properly set for the MOTOR-DA project. After the installation of Doxygen and Sphinx, run:


After the installation of Doxygen and Sphinx, run:

```bash
./compileDocs.sh
```
to build the docs of the project.

## Formatting (Important)
The project uses the fprettify to format the code. The script file is in the root directory of the project. Run the following command to format the code before merging the code to the main branch.:

```
# Under the root directory of the project
./updateFortranFormat.sh
```

## Team
* Yuanfu XIE (yuanfu_xie@yahoo.com), Director/Chief scientist 
* Zilong QIN (zilong.qin@gmail.com), Team leader/Architect

#### Core members 
* Yali WU
* Jilong CHEN
* Feng ZHENG
* Jiongming PANG
* Yongjian HUANG
* Guanqiu MA

#### Contributors
* Ting SHU
* Xuancheng Liu
* Sanshan TU

For collaborations, please contact Yuanfu Xie (yuanfu_xie@yahoo.com).
copyright (C) 2024 GBA-MWF, All rights reserved.

