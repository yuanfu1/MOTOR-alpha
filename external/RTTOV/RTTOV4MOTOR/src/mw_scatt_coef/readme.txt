HYDROMETEOR SCATTERING (HYDRO) TABLE GENERATION FOR RTTOV-SCATT   

Introduction
------------

The Hydro tables for use with RTTOV-SCATT contain pre-computed bulk-scattering
properties (extinction, single scattering albedo and asymmetry) as a function of
temperature, water content, and channel, for a variety of hydrometeor types.
There is a Hydro table for each different sensor. 

Hydro tables can be generated by running the script "hydro_table_generation.ksh" from the 
directory containing the hydro table generation software (src/mw_scatt_coef). All 
configuration  and input is specified in the file "channels.dat", which should be 
in the same directory. This enables you to configure:

a) The output directory for the hydro files (which are very large, i.e. 50MB - 200MB each)
b) Instruments, frequencies and hydrometeor types for which to generate Mie parameters
c) Some aspects of the microphysical details of the computation

There are two example files included in this distribution. 

channels.dat_all   - Will generate Hydro tables for most known instruments and also
                     (commented out) some for which no clear-sky RTTOV coefficients 
                     are available.
channels.dat_debug - Does computations for just a single frequency, to enable rapid
                     debug. By default, "channels.dat" is a copy of this

Compilation
-----------

Please refer to the RTTOV distribution readme.txt for general compilation
instructions. 

Running the code for the first time
-----------------------------------

The Mie computations are demanding. It may take a few minutes on a single-threaded
platform to generate one Hydro table and it will take quite a bit longer to generate 
all possible hydro tables. For speed (and with the right compiler) the computations 
can be run multi-threaded (but not multi-process) on a supercomputer or 
multi-core desktop.

The following steps are needed:

1) Build RTTOV in the usual way. This will create an executable called 
  "rttov_scatt_make_coef.exe" in the RTTOV bin directory

2) Start from one of the pro-forma "channels.dat_*", ideally making a copy as it will need editing.
   "channels.dat_debug" can be used to produce a rapid computation for testing purposes or 
   for getting the code up and running.

3) Specify an output directory in channels.dat. It is not recommended to use the
   standard RTTOV coefficients directory, because the newly create hydro tables 
   will overwrite the old. 

4) Run the script: 

./hydro_table_generation.ksh <name of channels.dat file>

5) (Optional) The ASCII hydro tables can be converted to binaries to save disk space 
and to give faster read times. Use the utility "rttov_ascii2bin_scatcoeffs" whose source
code is in the mw_scatt directory, and which will be built along with RTTOV, so
it should be found as bin/rttov_ascii2bin_scatcoeffs.exe. Note that binary files are not 
usually portable between different computers.

Scientific basis
----------------

The file "channels.dat" controls many of the scientific options, though not all.
For each hydrometeor type is is possible to choose a PSD and either the use of
Mie spheres with a density formulation, or (appropriate only to frozen 
hydrometeors) DDA shapes. Not all combinations of PSD and density relation will
work together. The original scientific description of the Mie computation can be found 
in Bauer (2001). This readme.txt is the best summary of the code as of June 2020 
but it is hoped to provide a number of papers summarising recent developments. Please see 
the bibliography.

There are an increasing variety of options for frozen hydrometeors. The 
presence of an option does not necessarily mean that it is recommended for general 
use. Petty and Huang (2010) argue "there is no basis for retaining any kind of soft 
sphere... as a model for the microwave properties of snowflakes". Clearly the field 
is moving towards more accurate approaches like the Discrete Dipole Approximation, 
but in NWP, we do not know about the microphysical details of the frozen particles. 
There is no perfect solution at the moment and the options available here reflect 
the spread of current thinking, and help demonstrate how sensitive the results can 
be to our assumptions regarding frozen particles.

The distributed "channels.dat_all" is set with the options that were used to 
create the hydro tables that are distributed via the RTTOV website. A good initial check is 
to see whether you can reproduce some of those, at least to around 7 significant figures.

Frequencies and instruments
---------------------------

This tool generates optical properties at a number of specified frequencies, which
can alternatively be the average of optical properties across two symmetric sidebands. 
This list follows the keyword FREQUENCIES in channels.dat. Polarisation can be specified, 
see later, but is normally ignored (set to -1)

Hydrotables are created for each instrument according to the list following the INSTRUMENTS
keyword. Normally, when ignoring polarisation, this is a list of frequencies at which the
instrument operates, given in channel order, but not per individual channels. However if 
polarised scattering properties are required, then this does need to be a list corresponding 
to the individual channels.

Scientific options
------------------

- Hydrometeor defintions -

RTTOV-SCATT works on an arbitrary set of hydrometeor types, by default the following 5,
in this order:

rain, snow, graupel, cloud water, cloud ice

It is up to the user of RTTOV-SCATT to make sure that the number and ordering of
their hydrometeor inputs corresponds to that in the coefficient file

- Particle size distributions -

Applicability: general

The following PSDs are available and may be applied to any hydrometeor type:

1) Pre-v13 RTTOV-SCATT gamma (special case of modified gamma, see set_spectra.F90)
2) Marshall-Palmer (special case of modified gamma, see set_spectra.F90)
3) Field et al. (2005; predict_psd.F90) 
4) Field et al. (2007; predict_psd_F07.F90)
5) Generalised modified gamma (Petty and Huang, 2011)
6) Heymsfield et al. (2013):
  - gamma distribution with lambda temperature dependence from Fig. 7b / Table 3
  - mu parameter depends on the gamma following Fig. 9a / Table 3 
  - Options are convective, stratiform or "all" (== "composite" in Fig. 7b)
  - N_0 is the free parameter
9) McFarquhar and Heymsfield (1997)

Further documentation of the precise settings is left to the code itself. Some 
combinations of PSD and particle shape or density may also generate an error 
if they imply excessive amounts of particles in the smallest size bin - this 
warning is: 

"Renormalisation of greater than 200% suggests a fundamental size distribution 
problem"

This issue is most prevalent for Liu shapes where the size ranges for which 
optical properties are available also implies a certain range of size bins.

The Panegrossi et al. (1998) n0 vs T formulation can optionally be switched on 
for the Marshall-Palmer distribution. This parametrisation modifies 
n0 in the distribution to account for the general observation 
that there are more and smaller particles at colder temperatures and fewer at 
warmer temperatures. 

- Density formulations - 

Applicability: Mie spheres

The following density distributions are available:

1) 0.132*D-1 (Wilson & Ballard, 1999) 
2) 8.74E-4*exp(-0.625D2) + 4.5E-5 (Jones, 1995) 
3) 0.035*D-1.1 (Brown & Francis, 1995) 
4) Constant density as defined in mod_mie.F90

Options 1-3 were explored by Doherty et al. (2007) for ice particles (the
Met Office totalice hydrometeor type). Option 4 has been the standard choice
in RTTOV-SCATT for rain, snow, cloud water and cloud ice. 

Density options are used in a number of areas in the Mie code (e.g. in the 
computation of permittivity and in the size distributions). See density_all.F90 
for more documentation.

-- Particle habit options

-- Option 1: use Mie sphere

-- Option 2: Liu (2008) DDA database of non-spherical particles -

Applicability: frozen hydrometeors

Liu computed bulk scattering properties for randomly-oriented frozen particles using
a DDA approach, and provided the results in the form of a database, available
from http://cirrus.met.fsu.edu/research/scatdb.html (now included with the
RTTOV package). 11 different particle habits were simulated (e.g. columns, plates, 
rosettes, and snowflakes). To use this in RTTOV, you must select one of these
habits (mixtures are not yet available). The DDA database has been implemented here
following the approach of Kulie et al (2010). The particle shape defines the mass-
density relation, so when a Liu DDA shape is used, the density option is ignored. 
Shapes are:

0  = long column
1  = short column
2  = block column
3  = thick plate
4  = thin plate
5  = 3-bullet rosette
6  = 4-bullet rosette
7  = 5-bullet rosette
8  = 6-bullet rosette
9  = sector snowflake
10 = dendrite snowflake

-- Option 3: ARTS particle database (Eriksson et al., 2018) -

Applicability: frozen hydrometeors

This database has a greater frequency validity range than Liu, going from 1 GHz to 886 GHz, 
making it the only possible non-spherical choice for instruments like SMOS or ICI. It includes
a sector snowflake that aims to replicate the one in the Liu database, but in practice produces
results that are a few K different. For the first time in RTTOV-SCATT, it also provides hail, graupel
and aggregate shapes.

1  = Plate Type 1
2  = Column Type 1
3  = 6-Bullet Rosette
4  = Perpendicular 4-Bullet Rosette
5  = Flat 3-Bullet Rosette
6  = Icon Cloud Ice
7  = Sector Snowflake
8  = Evans Snow Aggregate
9  = 8-Column Aggregate
10 = Large Plate Aggregate
11 = Large Column Aggregate
12 = Large Block Aggregate
13 = Icon Snow
14 = Icon Hail
15 = Gem Graupel
16 = Liquid Sphere

- Melting layer - 

Applicability: snow, graupel, aggregate 

Implements the melting layer of Bauer (2001). This is a layer of enhanced scattering
caused by water-coated frozen particles, and it exists only in the 273.15K 
temperature bin. Computations are always made using Mie spheres; other 
microphysical assumptions are also fixed and have been described in the paper.

- Liquid water permittivity -

Applicability: liquid water Mie spheres (i.e. rain and water cloud)

The Liebe-89 formulation (option 1) has been used in RTTOV-SCATT for many years, but two 
newly available models are now available:

-- (2) Rosenkranz (2015, IEEE TGARS)
-- (3) Turner, Kneifel & Cadeddu [TKC] (2016, J. Atm. and Oc. Tech)

Both of these improve the results of RTTOV-SCATT in supercooled liquid water clouds, and both 
have very similar performance between 19 Ghz and 183 GHz. However, TKC is not necessarily 
valid above that range.

- Controls over the integration -

Fill out missing sizes: Normally the d_min of the DDA shape sets the lower bound of the PSD integration,
with the additional constraint that Field 2007 PSDs should start from at least 100 microns. Activating this
option ignores this and uses the lower bound for the hydrometeor type specified in mod_scattering.F90.
Since DDA optical properties are not available for any sizes lower than the d_min of that shape, optical
properties will be provided using a fixed-density soft Mie sphere using the standard Mie settings
in mod_scattering.F90. These small particle sizes are assumed to be in the Rayleigh regime
where Mie will do a reasonable job, but it is up to the user to check this is sensible (possibly
using the diagnostic mode, see later).   

Old or new integration: Before v13, intgegration was on fixed size bins, with fairly coarse spacing
at small sizes, and used the rectangle rule, leading to significant inaccuracy in some cases. V13 
introduces a log-spaced set of integration points for better coverage of small particle sizes and 
a trapezium rule integration to provide better coverage of small particle sizes and hence help 
improve accuracy. However, some PSDs like Field (2007) can generate very sharp peaks at small sizes
that can still be hard to represent well in numerical integration. Unfortunately the Field 2007
water content to PSD-moment conversions seem to generate less renormalisation with the old integration,
so some hydrometeors retain this for consistency.

Renormalisation factor: This sets a maximum renormalisation beyond which an error will be reported 
and the table generation will stop.

See the diagnostic mode for mode details of the integration.

- Polarisation factor - 

A simple way to address polarised scattering from oriented hydrometeors is to adjust the
extinction according to the channel polarisation. Barlakas et al. (2020) found a universal 
scaling factor that is applied to ice hydrometeors in the main rttov_scatt code (in rttov_mieproc)
via ice_polarisation in rttov_options_scatt. Standard hydrotables do not contain per-channel
(e.g. polarised) optical properties; instead one table is provided per frequency and the 
frequencies are mapped onto channels within rttov_scatt. To allow more flexible polarised optical 
tables requires them to be provided on a per-channel basis instead. This can be achieved by specifying
a polarisation for each channel to be simulated by this tool (using the RTTOV standard numbering - see
channels.dat) and by setting the polarisation factor as a function of hydrometeor type in 
section M (as a fractional change to the extinction, to be added to extinction in h channels and 
removed extinction in v channels).

Diagnostic mode
---------------

There is a diagnostic mode for scientific debugging / understanding the PSD and optical 
property integrations at the heart of this tool. If the first non-comment line of a channels.dat 
file is "DIAG" then the diagnostic mode is triggered, and the following two lines specify the
parameters needed by this mode. channels.dat_debug gives an example:

DIAG
diag.txt
2 1e-2 23.8 223.0

The first line triggers diagnostic mode. The second line gives the filename to which to output diagnostic
information. The third line specifies the following 'coordinates' of the ingtegration to be diagnosed:

hydrometeor ID, as in mod_hydro.F90
water content [kg m^-3]
frequency [GHz]
temperature [K]

Hence this mode outputs the integration details for one hydrometeor, at one temperature, one frequency, and 
one water content. You will need to do multiple runs to explore different combinations. For mutliple sideband
channels, pick the frequency of one of the sidebands. The freqeuncy and temperature need to be picked 
fairly exactly to match one of the steps in the computation grid (there is only a 1e-3 tolerance for matching 
the frequency and the temperature) but the water content is matched to the nearest on the grid. See 
scattering_one_temp.F90 for more details.

The diagnostic output contains the following:

a) "Renormalisation - 1" - the renormalisation factor minus 1, i.e. the fractional
   scaling to the discretised, bounded PSD, to make the integral of this over particle mass
   equal to the desired water content.

b) Bulk extinction, scattering, backscatter cross sections [m^2] / g [0-1]' - these are
   the bulk optical properties that will be used to form the entries at one (wc,temp,freq) point 
   in the bulk property tables.

c) Columns giving the following values at each interation point:

D_g [m] - geometric (maximum dimension) diameter of the particle (the integration coordinate)
D_m [m] - mass-equivalent diameter of the particle
Mass [kg] - the mass of the single particle
Nd [m^-4] - the size distribution (after renormalisation)
Extinction [m^2] - the per-paricle extinction cross-section
Scattering [m^2] - the per-paricle scattering cross-section  
Backscatter [m^2] - the per-paricle backscattering cross-section 
Asymmetry [0-1] - the perparticle asymmetru factor
Extegrand - the extinction integrand at each point which, summed up, gives the bulk extinction.

References
----------

P. Bauer (2001). Atmospheric Research, 57, 9-30
Including a melting layer in microwave radiative transfer simulation for clouds.

P. Bauer (2002). NWP SAF Document No. NWPSAF-EC-TR-005
Microwave Radiative transfer modelling in clouds and precipitation.

P. R. A. Brown, P. N. Francis (1995). J. Atmos. Oceanic Technology. 12, 410-414
Improved Measurements of the ice water content in cirrus using a total-water probe.

A. M. Doherty, T. R. Sreerekha, U. M. O'Keeffe, S. J. English (2007). Q. J. R. Meteorol. Soc. 133, 1205-1212
Ice Hydrometeor Microphysical Assumptions in Radiative Transfer Models at AMSU-B Frequencies. 

P. R. Field, R. J. Hogan, P. R. A. Brown, A. J. Illingworth, T. W. Choularton, R. J. Cotton (2005). Q. J. R. Meteorol. Soc. 131, 1997-2017
Parameterization of ice-particle size distributions for mid-latitude stratiform cloud.

D. C. Jones (1995). PhD Thesis, University of Reading, Department of Meteorology
Validation of scattering microwave radiative transfer models using an aircraft radiometer and ground based radar.

D. R. Wilson, S. P. Ballard (1999). Q. J. R. Meteorol. Soc. 125, 557, 1607-1636
 A Microphysically based precipitation scheme for the meteorological office unified model.

G. Liu (2008). Bull. Am. Met. Soc., 89, 1563-1570
A database of microwave single-scattering properties for nonspherical ice particles. 
 (see also http://cirrus.met.fsu.edu/research/scatdb.html)

G. W. Petty, W. Huang, (2010) J. Atmos. Sci., 67, 769-787
Microwave backscatter and extinction by soft ice spheres and complex snow aggregates

G. W. Petty, W. Huang, (2011) J. Atmos. Sci., 68, 1460-1473
The modified gamma size distribution applied to inhomogeneous and nonspherical particles: 
Key relationships and conversions

M. S. Kulie, R. Bennartz, T. J. Greenwald, Y. Chen, F. Weng, (2010) J. Atmos. Sci, 67, 3471-3487
Uncertainties in micrwave properties of frozen precipitation: Implications for remote sensing and data assimilation

A. J. Geer and F. Baordo (2014), Atmos. Meas. Tech., 7 (6), 1839-1860
Improved scattering radiative transfer for frozen hydrometeors at microwave frequencies

P. Eriksson and coauthors (2018), Earth Syst. Sci. Data, 10, 1301-1326, https://doi.org/10.5194/essd-10-1301-2018, 2018.
A general database of hydrometeor single scattering properties at microwave and sub-millimetre wavelengths

K. Lonitz and A. J. Geer (2019), Atmos. Meas. Tech., 12, 405-429, https://doi.org/10.5194/amt-12-405-2019
Assessing the impact of different liquid water absorption models inside RTTOV-SCATT

P. W. Rosenkranz (2015), IEEE Transactions on Geoscience and Remote Sensing (Volume: 53, Issue: 3) 
A Model for the Complex Dielectric Constant of Supercooled Liquid Water at Microwave Frequencies

D. D. Turner, Kneifel, S., and Cadeddu (2016), M. P., J. Atm. and Oc. Tech, 33,“44, https://doi.org/10.1175/JTECH-D-15-0074.1
An Improved Liquid Water Absorption Model at Microwave Frequencies for Supercooled Liquid Water Clouds

McFarquhar, Greg M., and Andrew J. Heymsfield. Journal of the atmospheric sciences 54, no. 17 (1997): 2187-2200
Parameterization of tropical cirrus ice crystal size distributions and implications for 
radiative transfer: Results from CEPEX

Heymsfield, A.J., Schmitt, C. and Bansemer, A., 2013. Journal of the Atmospheric Sciences, 70(12), pp.4123-4154.
Ice cloud particle size distributions and pressure-dependent terminal velocities from 
in situ observations at temperatures from 0 to 86 C. 

Mätzler, C.: Microwave dielectric properties of ice., 2006. Thermal microwave radiation - Applications for remote sensing, 
Electromagn., Waves Ser., vol. 52, edited by: C. Mätzler, Inst. Eng. Technol., Stevenage, UK, Sect. 5.3, 455-462

Geer, A.J. and coauthors, 2020: Simulating the bulk optical properties of scattering hydrometeors: the 
RTTOV-SCATT hydrotable generator at RTTOV v13, in preparation

Barlakas, V, Geer AJ and Eriksson, P, 2020: Introducing hydrometeor orientation into all-sky 
millimeter/sub-millimeter assimilation, to be submitted to Atmos. Meas. Tech.

